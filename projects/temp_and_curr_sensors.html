<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brecht Opstaele ‚Äî Firmware Engineer</title>
  <meta name="description" content="M5Stack Atom Lite ESP32 nodes running Tasmota to measure temperature (DS18B20) and AC/DC current (ACS712 + ADS1115), publishing over MQTT to InfluxDB + Grafana."/>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2740%27 fill=%27%237c3aed%27/%3E%3C/svg%3E" />
  <meta property="og:title" content="Brecht Opstaele ‚Äî Firmware Engineer" />
  <meta property="og:description" content="DSP18B20 and ACS712+ADS1115 on ESP32 (Tasmota), MQTT to InfluxDB + Grafana." />
  <meta property="og:type" content="website" />
  <!-- Minimal in-page styles to polish code blocks & figures using your existing CSS variables -->
  <style>
    pre {
      margin: var(--space) 0;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-muted);
      box-shadow: var(--shadow);
      overflow-x: auto;
      line-height: 1.45;
    }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .k { color: #c792ea; }  /* keys/keywords hint */
    .s { color: #80cbc4; }  /* strings hint */
    .n { color: #a6accd; }  /* numbers hint */
    .cmt { color: var(--text-muted); font-style: italic; }
    figure { margin: var(--space) 0; }
    .figure {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, color-mix(in oklab, var(--bg-muted), transparent 20%), transparent 70%), var(--bg);
      padding: var(--space);
      box-shadow: var(--shadow);
    }
    figcaption { color: var(--text-muted); margin-top: 8px; font-size: .95em; }
    .legend { font-size: .9em; fill: var(--text-muted); }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background: color-mix(in oklab, var(--accent), transparent 88%); margin-left: 6px; font-size: .85em; }
  </style>
</head>

<body>
  <!-- Top navigation (matches your main site) -->
  <header class="container">
    <nav class="cluster site-nav">
      <div class="cluster">
        <span class="badge"><a href="../index.html#experience">Experience</a></span>
        <span class="badge"><a href="../index.html#education">Education</a></span>
        <span class="badge"><a href="../index.html#projects">Projects</a></span>
        <span class="badge"><a href="../index.html#skills">Skills</a></span>
        <span class="badge"><a href="../index.html#photography">Photography</a></span>
        <button class="button ghost" id="themeToggle" aria-label="Toggle theme">üåì</button>
      </div>
    </nav>
  </header>

  <main id="top">
    <!-- Intro / Summary -->
    <section id="introduction" class="container mt-3">
      <div class="hero">
        <h1 class="mb-1">ESP32 Temperature & Current Sensors <span class="chip">Tasmota</span></h1>
        <p class="mt-1 mb-0">
          Compact sensor nodes built on <strong>M5Stack Atom Lite (ESP32)</strong> running <strong>Tasmota</strong>.
          Nodes measure <strong>temperature (DS18B20)</strong> and <strong>current (ACS712 via ADS1115)</strong>, publish over
          <strong>MQTT</strong> to a <strong>Mosquitto</strong> broker, and store metrics in <strong>InfluxDB</strong> for visualization in <strong>Grafana</strong>.
        </p>
      </div>

      <div class="grid auto-fit mt-2">
        <article class="card">
          <div class="title">What you get</div>
          <ul class="mb-0">
            <li>Wiring diagrams for temperature and current nodes</li>
            <li>Docker Compose for Mosquitto, InfluxDB, Grafana, Node‚ÄëRED</li>
            <li>Tasmota setup (GPIOs, ADS1115, MQTT, rules, telemetry)</li>
            <li>MQTT topic examples + sample payload</li>
          </ul>
        </article>

        <article class="card">
          <div class="title">Bill of Materials</div>
          <ul class="mb-0">
            <li>M5Stack Atom Lite (ESP32), USB‚ÄëC PSU</li>
            <li>DS18B20 probes + 4.7‚ÄØkŒ© pull‚Äëup</li>
            <li>ACS712 (5‚ÄØA / 20‚ÄØA / 30‚ÄØA modules)</li>
            <li>ADS1115 16‚Äëbit ADC (I¬≤C)</li>
            <li>Dupont leads, small breadboard or terminal block</li>
            <li>Enclosure (optional, recommended)</li>
          </ul>
        </article>
      </div>
    </section>

    <!-- System overview -->
    <section id="overview" class="container mt-3">
      <h2>System overview</h2>
      <pre><code>[Sensors] ‚Üí [ESP32 (Tasmota)] ‚Üí MQTT ‚Üí Mosquitto ‚Üí InfluxDB ‚Üí Grafana
                            ‚Üò Node‚ÄëRED (optional transform)</code></pre>
      <p class="text-muted">
        Tip: give each node a unique <em>DeviceName</em> / <em>Topic</em> so you can separate telemetry and dashboards per location.
      </p>
    </section>

    <!-- Hardware details + Wiring -->
    <section id="hardware" class="container mt-3">
      <h2>Hardware</h2>

      <div class="grid auto-fit">
        <article class="card">
          <div class="title">Temperature node</div>
          <div class="subtitle">DS18B20 (1‚ÄëWire) on GPIO25</div>
          <p>
            The DS18B20 is simple and robust. Use a <strong>4.7‚ÄØkŒ©</strong> pull‚Äëup from <em>DATA</em> to <em>3V3</em>.
            Multiple DS18B20 sensors can share the same data line.
          </p>
          <figure class="figure">
            <!-- Simple inline SVG wiring diagram -->
            <svg viewBox="0 0 760 320" width="100%" role="img" aria-label="DS18B20 wiring to ESP32 (GPIO25)">
              <!-- ESP32 block -->
              <rect x="30" y="40" width="240" height="220" rx="12" fill="none" stroke="var(--border)" stroke-width="2"/>
              <text x="150" y="66" text-anchor="middle" font-weight="700">ESP32 (Atom Lite)</text>

              <!-- Pins -->
              <circle cx="70" cy="110" r="6" fill="#22c55e"/><text x="90" y="114">3V3</text>
              <circle cx="70" cy="150" r="6" fill="#a6adc8"/><text x="90" y="154">GND</text>
              <circle cx="70" cy="190" r="6" fill="#7c3aed"/><text x="90" y="194">GPIO25 (1‚ÄëWire)</text>

              <!-- DS18B20 block -->
              <rect x="460" y="40" width="240" height="220" rx="12" fill="none" stroke="var(--border)" stroke-width="2"/>
              <text x="580" y="66" text-anchor="middle" font-weight="700">DS18B20</text>
              <circle cx="510" cy="110" r="6" fill="#22c55e"/><text x="530" y="114">VDD</text>
              <circle cx="510" cy="150" r="6" fill="#a6adc8"/><text x="530" y="154">GND</text>
              <circle cx="510" cy="190" r="6" fill="#7c3aed"/><text x="530" y="194">DATA</text>

              <!-- Wires -->
              <line x1="70" y1="110" x2="510" y2="110" stroke="#22c55e" stroke-width="2"/>
              <line x1="70" y1="150" x2="510" y2="150" stroke="#a6adc8" stroke-width="2"/>
              <line x1="70" y1="190" x2="510" y2="190" stroke="#7c3aed" stroke-width="2"/>

              <!-- Pull-up resistor (4.7k) between DATA and 3V3 -->
              <line x1="310" y1="190" x2="310" y2="110" stroke="#ff9800" stroke-width="3"/>
              <rect x="300" y="140" width="20" height="20" fill="#ff9800"/>
              <text class="legend" x="295" y="208">4.7‚ÄØkŒ©</text>
            </svg>
            <figcaption>DS18B20 on GPIO25 with 4.7‚ÄØkŒ© pull‚Äëup to 3V3.</figcaption>
          </figure>
        </article>

        <article class="card">
          <div class="title">Current node</div>
          <div class="subtitle">ACS712 ‚Üí ADS1115 ‚Üí I¬≤C (ESP32)</div>
          <p>
            The ACS712 outputs an analog voltage proportional to current. The ADS1115 16‚Äëbit ADC reads the value over I¬≤C.
            Use a separate node (or different GPIOs) from the temperature node to avoid pin conflicts.
          </p>
          <figure class="figure">
            <!-- Inline SVG: ACS712 -> ADS1115 -> ESP32 -->
            <svg viewBox="0 0 860 380" width="100%" role="img" aria-label="ACS712 to ADS1115 to ESP32 wiring">
              <!-- ESP32 -->
              <rect x="40" y="40" width="240" height="280" rx="12" fill="none" stroke="var(--border)" stroke-width="2"/>
              <text x="160" y="66" text-anchor="middle" font-weight="700">ESP32 (Atom Lite)</text>
              <circle cx="80" cy="110" r="6" fill="#22c55e"/><text x="100" y="114">3V3</text>
              <circle cx="80" cy="150" r="6" fill="#a6adc8"/><text x="100" y="154">GND</text>
              <circle cx="80" cy="190" r="6" fill="#7c3aed"/><text x="100" y="194">GPIO21 (SDA)</text>
              <circle cx="80" cy="230" r="6" fill="#7c3aed"/><text x="100" y="234">GPIO25 (SCL)</text>

              <!-- ADS1115 -->
              <rect x="320" y="40" width="220" height="280" rx="12" fill="none" stroke="var(--border)" stroke-width="2"/>
              <text x="430" y="66" text-anchor="middle" font-weight="700">ADS1115 (0x48)</text>
              <!-- Power pins -->
              <circle cx="360" cy="110" r="6" fill="#22c55e"/><text x="380" y="114">VDD</text>
              <circle cx="360" cy="150" r="6" fill="#a6adc8"/><text x="380" y="154">GND</text>
              <!-- I2C -->
              <circle cx="360" cy="190" r="6" fill="#7c3aed"/><text x="380" y="194">SDA</text>
              <circle cx="360" cy="230" r="6" fill="#7c3aed"/><text x="380" y="234">SCL</text>
              <!-- Analog inputs -->
              <circle cx="500" cy="110" r="6" fill="#06b6d4"/><text x="520" y="114">A0</text>
              <circle cx="500" cy="150" r="6" fill="#06b6d4"/><text x="520" y="154">A1</text>
              <circle cx="500" cy="190" r="6" fill="#06b6d4"/><text x="520" y="194">A2</text>
              <circle cx="500" cy="230" r="6" fill="#06b6d4"/><text x="520" y="234">A3 (ref)</text>

              <!-- ACS712 x2 -->
              <rect x="610" y="60" width="200" height="120" rx="12" fill="none" stroke="var(--border)" stroke-width="2"/>
              <text x="710" y="86" text-anchor="middle" font-weight="700">ACS712 #1</text>
              <circle cx="630" cy="120" r="6" fill="#06b6d4"/><text x="650" y="124">Vout ‚Üí A0</text>
              <circle cx="630" cy="150" r="6" fill="#22c55e"/><text x="650" y="154">VCC</text>
              <circle cx="630" cy="180" r="6" fill="#a6adc8"/><text x="650" y="184">GND</text>

              <rect x="610" y="210" width="200" height="120" rx="12" fill="none" stroke="var(--border)" stroke-width="2"/>
              <text x="710" y="236" text-anchor="middle" font-weight="700">ACS712 #2</text>
              <circle cx="630" cy="270" r="6" fill="#06b6d4"/><text x="650" y="274">Vout ‚Üí A1</text>
              <circle cx="630" cy="300" r="6" fill="#22c55e"/><text x="650" y="304">VCC</text>
              <circle cx="630" cy="330" r="6" fill="#a6adc8"/><text x="650" y="334">GND</text>

              <!-- Wires -->
              <!-- ESP32 power to ADS1115 -->
              <line x1="80" y1="110" x2="360" y2="110" stroke="#22c55e" stroke-width="2"/>
              <line x1="80" y1="150" x2="360" y2="150" stroke="#a6adc8" stroke-width="2"/>
              <!-- I2C -->
              <line x1="80" y1="190" x2="360" y2="190" stroke="#7c3aed" stroke-width="2"/>
              <line x1="80" y1="230" x2="360" y2="230" stroke="#7c3aed" stroke-width="2"/>
              <!-- ADS to ACS -->
              <line x1="500" y1="110" x2="630" y2="120" stroke="#06b6d4" stroke-width="2"/>
              <line x1="500" y1="150" x2="630" y2="270" stroke="#06b6d4" stroke-width="2"/>
              <!-- Power to ACS -->
              <line x1="360" y1="110" x2="630" y2="150" stroke="#22c55e" stroke-width="2"/>
              <line x1="360" y1="150" x2="630" y2="180" stroke="#a6adc8" stroke-width="2"/>
              <line x1="360" y1="110" x2="630" y2="300" stroke="#22c55e" stroke-width="2"/>
              <line x1="360" y1="150" x2="630" y2="330" stroke="#a6adc8" stroke-width="2"/>
              <!-- A3 ref to VCC -->
              <line x1="500" y1="230" x2="360" y2="110" stroke="#ff9800" stroke-width="3"/>
              <text class="legend" x="470" y="248">A3 tied to VDD as reference</text>
            </svg>
            <figcaption>ADS1115 on I¬≤C (ESP32 GPIO21=SDA, GPIO25=SCL), ACS712 outputs to A0/A1. A3 tied to VDD for reference.</figcaption>
          </figure>
          <p class="text-muted mb-0">
            Use <strong>one node per sensor type</strong> (temperature vs current) or ensure pin assignments don‚Äôt conflict.
          </p>
        </article>
      </div>
    </section>

    <!-- Docker stack -->
    <section id="docker" class="container mt-3">
      <h2>Docker: Mosquitto, InfluxDB, Grafana, Node‚ÄëRED</h2>
      <p>
        Drop this <code>compose.yaml</code> alongside <code>./mqtt</code>, <code>./influxdb</code>, <code>./grafana</code>, and
        <code>./nodered</code> folders. Adjust environment variables as needed. Then run <code>docker compose up -d</code>.
      </p>
      <pre><code class="language-yaml">version: "<span class="s">3.9</span>"
services:
  influxdb:
    image: <span class="s">influxdb:1.11</span>
    container_name: <span class="s">influxdb</span>
    restart: <span class="s">unless-stopped</span>
    ports: [<span class="s">"8086:8086"</span>]
    environment:
      INFLUXDB_DB: <span class="s">${INFLUXDB_DB:-sensors}</span>
      INFLUXDB_USER: <span class="s">${INFLUXDB_USER:-writer}</span>
      INFLUXDB_USER_PASSWORD: <span class="s">${INFLUXDB_USER_PASSWORD:-changeme}</span>
    volumes:
      - <span class="s">./influxdb:/var/lib/influxdb</span>

  grafana:
    image: <span class="s">grafana/grafana:latest</span>
    container_name: <span class="s">grafana</span>
    restart: <span class="s">unless-stopped</span>
    ports: [<span class="s">"3000:3000"</span>]
    environment:
      GF_SECURITY_ADMIN_USER: <span class="s">${GF_SECURITY_ADMIN_USER:-admin}</span>
      GF_SECURITY_ADMIN_PASSWORD: <span class="s">${GF_SECURITY_ADMIN_PASSWORD:-admin}</span>
    volumes:
      - <span class="s">./grafana/grafana.ini:/etc/grafana/grafana.ini</span>
      - <span class="s">grafana:/var/lib/grafana</span>
    depends_on: [<span class="s">influxdb</span>]

  nodered:
    image: <span class="s">nodered/node-red:latest</span>
    container_name: <span class="s">nodered</span>
    restart: <span class="s">unless-stopped</span>
    ports: [<span class="s">"1880:1880"</span>]
    environment:
      - <span class="s">NODE_RED_ENABLE_SAFE_MODE=true</span>
      - <span class="s">NODE_RED_ENABLE_PROJECTS=true</span>
    volumes:
      - <span class="s">./nodered:/data</span>
    depends_on: [<span class="s">influxdb</span>, <span class="s">grafana</span>]

  mqtt:
    image: <span class="s">eclipse-mosquitto:latest</span>
    container_name: <span class="s">mqtt</span>
    restart: <span class="s">unless-stopped</span>
    ports: [<span class="s">"1883:1883"</span>, <span class="s">"9001:9001"</span>]
    volumes:
      - <span class="s">./mqtt/config:/mosquitto/config</span>
      - <span class="s">./mqtt/data:/mosquitto/data</span>
      - <span class="s">./mqtt/log:/mosquitto/log</span>
      - <span class="s">./mqtt/certs:/mosquitto/certs:ro</span>

volumes:
  grafana:</code></pre>
      <p class="text-muted">
        For InfluxDB 1.x, you can write line protocol directly from Node‚ÄëRED (MQTT ‚Üí Function ‚Üí InfluxDB node).
      </p>
    </section>

    <!-- Tasmota configuration -->
    <section id="tasmota" class="container mt-3">
      <h2>Tasmota configuration</h2>

      <div class="grid auto-fit">
        <article class="card">
          <div class="title">Temperature node</div>
          <div class="subtitle">DS18B20 on GPIO25</div>
          <p>In the Tasmota web UI:</p>
          <ul>
            <li><strong>Configuration ‚Üí Configure Module</strong> ‚Üí set <em>GPIO25</em> to <em>DS18x20</em></li>
            <li><strong>Configuration ‚Üí Configure MQTT</strong> ‚Üí set broker/credentials, e.g. host <code>192.168.10.25</code></li>
            <li><strong>Configuration ‚Üí Logging</strong> ‚Üí <em>Telemetry period</em>: <code>10</code> seconds</li>
          </ul>
          <p>Console (one‚Äëliner):</p>
          <pre><code class="language-text">Backlog DeviceName Temp1; FriendlyName1 Temp1; TelePeriod 10; 
 MqttHost 192.168.10.25; Topic TempSens/Temp1</code></pre>
          <p class="mb-0 text-muted">
            If you have multiple DS18B20s on one line, each will appear by unique ROM Id in <code>tele/.../SENSOR</code>.
          </p>
        </article>

        <article class="card">
          <div class="title">Current node</div>
          <div class="subtitle">ADS1115 + ACS712 (I¬≤C on GPIO21/25)</div>
          <p>In the Tasmota web UI for the current node:</p>
          <ul>
            <li><strong>Configure Module</strong> ‚Üí set <em>GPIO21 = I2C SDA</em>, <em>GPIO25 = I2C SCL</em></li>
            <li><strong>Configure MQTT</strong> ‚Üí broker/credentials; set topic e.g. <code>CurrSens/5A</code></li>
            <li>Ensure ADS1115 is detected (check <code>i2cscan</code> in console ‚Üí address <code>0x48</code> typical)</li>
          </ul>
          <p>Console (template rule for a ‚Äú5A‚Äù unit; repeat with topic <code>CurrSens/20A</code> & <code>CurrSens/30A</code> on other nodes):</p>
          <pre><code class="language-text">Backlog DeviceName Curr5A; FriendlyName1 Curr5A; TelePeriod 10; Topic CurrSens/5A

Rule1
 ON ADS1115#A0 DO Var1 %value% ENDON
 ON ADS1115#A1 DO Var2 %value% ENDON
 ON ADS1115#A2 DO Var3 %value% ENDON
 ON ADS1115#A3 DO Publish tele/CurrSens/5A {"A0":%Var1%,"A1":%Var2%,"A2":%Var3%,"A3":%value%} ENDON

Rule1 1</code></pre>
          <p class="text-muted mb-0">
            <em>A3 tied to VDD</em> lets you derive offset/gain later. You can linearize per sensor in Node‚ÄëRED or Grafana.
          </p>
        </article>
      </div>
    </section>

    <!-- MQTT examples -->
    <section id="mqtt" class="container mt-3">
      <h2>MQTT topics & payload</h2>
      <div class="grid auto-fit">
        <article class="card">
          <div class="title">Suggested topics</div>
          <pre><code class="language-text">tele/TempSens/Temp1/SENSOR
tele/CurrSens/5A
tele/CurrSens/20A
tele/CurrSens/30A</code></pre>
        </article>
        <article class="card">
          <div class="title">Sample payloads</div>
          <div class="subtitle">Temperature</div>
          <pre><code class="language-json">{
  "Time": "2026-01-27T12:00:00",
  "DS18B20": { "Id": "28-3C01D6071A", "Temperature": 22.8 }
}</code></pre>
          <div class="subtitle">Current (ADS1115 raw)</div>
          <pre><code class="language-json">{
  "A0": 11432,
  "A1":  9830,
  "A2": 11210,
  "A3": 16383
}</code></pre>
          <p class="mb-0 text-muted">
            Convert raw counts ‚Üí amperes using your chosen calibration in Node‚ÄëRED/InfluxDB/Grafana.
          </p>
        </article>
      </div>
    </section>

    <!-- Quick calibration approach -->
    <section id="calibration" class="container mt-3">
      <h2>Calibration (quick)</h2>
      <ol>
        <li>Record <em>no‚Äëload</em> values for each ACS712 channel (average several seconds of A0/A1/A2).</li>
        <li>Measure a <em>known load</em> (e.g., a resistive lamp or heater). Compute <code>gain = (counts_diff ‚Üí volts ‚Üí amps)</code>.</li>
        <li>In Node‚ÄëRED or Grafana, apply: <code>I[A] = (raw - offset) * k</code>. Store <em>offset</em> and <em>k</em> per channel.</li>
      </ol>
      <p class="text-muted mb-0">
        This keeps Tasmota simple and moves calibration math to your data pipeline.
      </p>
    </section>

    <!-- Wrap-up -->
    <section id="wrapup" class="container mt-3">
      <h2>Wrap‚Äëup</h2>
      <p>
        With the two nodes online and publishing, wire the MQTT topics into Node‚ÄëRED (optional) to write InfluxDB line protocol,
        then build Grafana panels per device (temperature trends, current per channel, alerts).
      </p>
      <p class="mb-0">
        That‚Äôs it ‚Äî you now have a robust, dockerized sensor backend with clean, repeatable ESP32 nodes.
      </p>
    </section>
  </main>

  <footer>
    <p><a href="../index.html">‚Üê Back to Home</a></p>
  </footer>

  <footer class="container footer center">
    <span class="badge">v1.1</span>
    <span class="ml-1">¬© <span id="year"></span> Brecht Opstaele</span>
  </footer>

  <script>
    // Theme toggle (respects system pref; manual override)
    const btn = document.getElementById('themeToggle');
    const root = document.documentElement;
    const stored = localStorage.getItem('theme');
    if (stored) root.dataset.theme = stored;
    btn.addEventListener('click', () => {
      const current = root.dataset.theme === 'dark' ? 'light' : 'dark';
      root.dataset.theme = current;
      localStorage.setItem('theme', current);
    });
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
